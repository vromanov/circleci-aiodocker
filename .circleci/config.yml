version: 2
jobs:
  build:
    working_directory: /app
    docker:
      - image: docker:17.09.0-ce

    steps:
      - setup_remote_docker:
          version: 17.09.0-ce
          docker_layer_caching: true

      - checkout

      - run:
          name: Build container
          command: |
            export CIRCLE_SHORT_SHA1=$(echo $CIRCLE_SHA1 | cut -c -7)
            ls -la
            docker build -t circleci-aiodocker:$CIRCLE_SHORT_SHA1 .

      - run:
          name: Run container
          command: |
            export CIRCLE_SHORT_SHA1=$(echo $CIRCLE_SHA1 | cut -c -7)
            DOCKER_ENV_FILE=$(mktemp)
            echo CI > $DOCKER_ENV_FILE
            echo AWS_ACCESS_KEY_ID=key >> $DOCKER_ENV_FILE
            echo AWS_SECRET_ACCESS_KEY=secret >> $DOCKER_ENV_FILE
            env | grep CIRCLE >> $DOCKER_ENV_FILE
            env | grep CODECOV >> $DOCKER_ENV_FILE
            env | grep DOCKER_ >> $DOCKER_ENV_FILE
            docker run --rm --env-file $DOCKER_ENV_FILE \
                circleci-aiodocker:$CIRCLE_SHORT_SHA1 pytest -s -vv tests

